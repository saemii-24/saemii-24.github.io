---
title: "Middleware - ê³µì‹ë¬¸ì„œ ë²ˆì—­í•˜ë©´ì„œ ì´í•´í•´ë³´ê¸°"
author: saemii
categories:
  - Nextjs
tags:
  - [Nextjs]
date: 2025-05-01
last_modified_at: 2025-05-01
pin: true
---

# âœ ë¯¸ë“¤ì›¨ì–´ê°€ í•„ìš”í•˜ë‹¤!

ì›¹ì‚¬ì´íŠ¸ë¥¼ ë§Œë“¤ë‹¤ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ë¥¼ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ìƒí™©ì„ ë§Œë‚  ìˆ˜ ìˆë‹¤.ğŸ‘€

1. ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ í–ˆëŠ”ë° ë¡œê·¸ì¸ í˜ì´ì§€ì— ì‹œë„í•˜ëŠ” ê²½ìš°
2. ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ í•˜ì§€ ì•Šì•˜ìŒì—ë„ ë³´í˜¸ë˜ëŠ” ì£¼ì†Œì— ì ‘ê·¼í•˜ë ¤ëŠ” ê²½ìš°
3. ì‚¬ìš©ìì—ê²Œ ê¶Œí•œì´ ì—†ìŒì—ë„ ì‚¬ìš©ìê°€ í•´ë‹¹ ì£¼ì†Œì— ì ‘ê·¼í•˜ë ¤ëŠ” ê²½ìš°

ì—…ë¬´ì—ì„œëŠ” next.jsì™€ next-authë¥¼ ì£¼ë¡œ ì‚¬ìš©í•˜ê³  ìˆëŠ” ë§Œí¼ `useSession`ë¥¼ í™œìš©í•´ **client side**ì—ì„œ `useEffect`ë¡œ ì²˜ë¦¬í•´ë„ ê°€ëŠ¥í•˜ì§€ë§Œ, client sideì´ë‹¤ ë³´ë‹ˆ í•œë²ˆì€ ë Œë”ë§ì´ ë˜ê³  ê·¸ ë‹¤ìŒ ì•¡ì…˜ì´ ì´ë£¨ì–´ì ¸ì•¼ í•˜ë¯€ë¡œ ì‚¬ìš©ìëŠ” í™”ë©´ì´ ê¹œë¹¡ì¸ë‹¤ê³  ëŠë‚„ ìˆ˜ ìˆë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê³ ì Middlewareë¥¼ í™œìš©í•˜ê³  ìˆì—ˆëŠ”ë°, ìµœê·¼ì— ë‹¤ì‹œ í•œ ë²ˆ Middleware íŒŒì¼ì„ ì‘ì—…í•  ì¼ì´ ìˆì–´, ê²¸ì‚¬ê²¸ì‚¬ ì •ë¦¬í•´ë³´ê³ ì í•œë‹¤.

ë‚´ìš©ì€ [Next.js ê³µì‹ë¬¸ì„œ](https://nextjs.org/docs/app/building-your-application/routing/middleware)ì˜ 15.3.1 app routerë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œë‹¤.

# ğŸ¤” ë¯¸ë“¤ì›¨ì–´ë€ ë¬´ì—‡ì¼ê¹Œ?

ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ë©´ ì„œë²„ì— ë³´ë‚´ëŠ” ìš”ì²­ì´ ì™„ë£Œë˜ê¸° ì „ì— ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ ì•„ë˜ì™€ ê°™ì€ ìƒí™©ì— ìœ ìš©í•˜ê²Œ ì‚¬ìš©ëœë‹¤.

- ìš”ì²­ì˜ ì¼ë¶€ ê°’ì„ ì½ì€ í›„ ë¹ ë¥´ê²Œ redirectí•  ë•Œ
- A/B í…ŒìŠ¤íŠ¸ ë˜ëŠ” ì‹¤í—˜ì— ë”°ë¼ ë‹¤ë¥¸ í˜ì´ì§€ë¡œ rewriteí•  ë•Œ
- ì „ì²´ í˜ì´ì§€ ë˜ëŠ” ì¼ë¶€ í˜ì´ì§€ì˜ í—¤ë”ë¥¼ ìˆ˜ì •í•  ë•Œ

ë‹¤ë§Œ, ì•„ë˜ì™€ ê°™ì€ ìƒí•­ì—ëŠ” ì í•©í•˜ì§€ ì•Šë‹¤.

- ëŠë¦° ë°ì´í„° fetching
- ì„¸ì…˜ ê´€ë¦¬

## ğŸ’Œ Convention

app routerì—ì„œëŠ” appê³¼ ë‚˜ë€íˆ ë‘ë©´ ëœë‹¤.
ë‚˜ëŠ” í˜„ì¬ `src/app` ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— `src/middleware.ts`ë¡œ ìœ„ì¹˜ì‹œì¼°ë‹¤.

```
src/
â”œâ”€â”€ app/
â”œâ”€â”€ middleware.ts
```

## ğŸ’¥ ê²½ë¡œ ë§ì¶”ê¸°

ë¯¸ë“¤ì›¨ì–´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í”„ë¡œì íŠ¸ì˜ ëª¨ë“  ê²½ë¡œì—ì„œ ì‹¤í–‰ë˜ëŠ” ë§Œí¼, íŠ¹ì • ê²½ë¡œì—ì„œë§Œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ ì œì™¸í•˜ê³  ì‹¶ë‹¤ë©´ matcherë¥¼ ì‚¬ìš©í•´ì•¼ ëœë‹¤. ~~ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ ë¬´í•œ ë£¨í”„ ì—ëŸ¬ë¥¼ ë§Œë‚˜ë³¼ ìˆ˜ ìˆë‹¤~~

ì•„ë˜ëŠ” ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë˜ëŠ” ìˆœì„œë‹¤.

1. `next.config.js`ì˜ `header`
2. `next.config.js`ì˜ `redirects`
3. ë¯¸ë“¤ì›¨ì–´ (`rewrites`, `redirects` ë“±)
4. `beforeFiles` `next.config.js`ì˜ `rewrites`
5. íŒŒì¼ ì‹œìŠ¤í…œ ê²½ë¡œ (`public/`, `_next/static/`, `pages/`, `app/` ë“±)
6. `afterFiles` `next.config.js`ì˜ `rewrites`
7. Dynamic Routes (`/blog/[slug]`)
8. `fallback` `next.config.js`ì˜ `rewrites`

### ğŸ“ŒbeforeFilesì™€ afterFiles

beforeFilesì™€ afterFilesê°€ ì •í™•íˆ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ” ê²ƒì¼ê¹Œ? ğŸ¤” ê¶ê¸ˆí•´ì„œ ì°¾ì•„ë³´ë‹ˆ ê³µì‹ë¬¸ì„œ [rewrites](https://nextjs.org/docs/app/api-reference/config/next-config-js/rewrites) ë¶€ë¶„ì—ì„œ ìì„¸íˆ ë‹¤ë£¨ê³  ìˆì—ˆë‹¤.

rewritesëŠ” URLì€ ìœ ì§€í•˜ë©´ì„œ ë‹¤ë¥¸ í˜ì´ì§€ë‚˜ ë¦¬ì†ŒìŠ¤ë¡œ routing í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê¸°ëŠ¥ì´ë‹¤.

> âœ¨ ì˜ˆì‹œ
> í´ë¼ì´ì–¸íŠ¸ê°€ ì£¼ì†Œì°½ì— Aë¼ëŠ” ì£¼ì†Œë¥¼ ì…ë ¥í•˜ë”ë¼ë„, rewrites ê¸°ëŠ¥ì„ ì´ìš©í•´ 'A' ë¼ê³  í‘œì‹œëŠ” ë˜ì§€ë§Œ ì‹¤ì œë¡œ 'B' ê²½ë¡œì— ë§ëŠ” ê¸°ëŠ¥ì„ ì²˜ë¦¬í•œë‹¤.

ì´ ê¸°ëŠ¥ì„ í™œìš©í•˜ê¸° ìœ„í•œ `rewrites()` í•¨ìˆ˜ì—ì„œ ë‹¨ìˆœí•œ ë°°ì—´ì´ ì•„ë‹Œ ê°ì²´ í˜•íƒœë¡œ `beforeFiles`, `afterFiles`, `fallback`ì„ ë°˜í™˜í•  ë•Œ ë¼ìš°íŒ… ìˆœì„œë¥¼ ì •êµí•˜ê²Œ ì œì–´í•  ìˆ˜ ìˆë‹¤.

```javascript
module.exports = {
  async rewrites() {
    return {
      beforeFiles: [
        // beforeFilesì— ì‘ì„±í•œ ê²½ìš° headers/redirects ì´í›„ì— ì²´í¬ë˜ë©°,
        // _next/public íŒŒì¼ì„ í¬í•¨í•œ ëª¨ë“  íŒŒì¼ ì´ì „ì— ì‹¤í–‰ëœë‹¤.
        // ì¦‰, ê¸°ì¡´ í˜ì´ì§€ íŒŒì¼ë“¤ì„ ë®ì–´ì“¸ ìˆ˜ ìˆë‹¤.
        {
          source: '/some-page',
          destination: '/somewhere-else',
          has: [{ type: 'query', key: 'overrideMe' }],
        },
      ],
      afterFiles: [
        // afterFilesì— ì‘ì„±í•œ ê²½ìš° pages/public íŒŒì¼ë“¤ì„ ë¨¼ì € í™•ì¸í•œ í›„,
        // ë™ì  ë¼ìš°íŠ¸(dynamically matched routes) ì´ì „ì— ì‹¤í–‰ëœë‹¤.
        {
          source: '/non-existent',
          destination: '/somewhere-else',
        },
      ],
      fallback: [
        // ì´ rewritesëŠ” pages/public íŒŒì¼ê³¼ ë™ì  ë¼ìš°íŠ¸ë¥¼
        // ëª¨ë‘ í™•ì¸í•œ ì´í›„, 404 í˜ì´ì§€ê°€ ë Œë”ë§ë˜ê¸° ì „ì— ì‹¤í–‰ëœë‹¤. (ì¦‰ ëª¨ë“  ë¼ìš°íŒ… ì‹œë„ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤í–‰ë¨)
        {
          source: '/:path*',
          destination: `https://my-old-site.com/:path*`,
        },
      ],
    }
  },
}

```


### ğŸ“Œ ì‹¤í–‰ ê²½ë¡œ ì •ì˜í•˜ê¸°

ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë  ê²½ë¡œë¥¼ ì •ì˜í•˜ëŠ” ë°©ë²•ì€ **ë‘ ê°€ì§€**ê°€ ìˆë‹¤.

1. **ì»¤ìŠ¤í…€ ë§¤ì²˜(config ì‚¬ìš©)**

   - íŠ¹ì • ê²½ë¡œì— ëŒ€í•´ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

2. **ì¡°ê±´ë¬¸ ì‚¬ìš©**
   - ë¯¸ë“¤ì›¨ì–´ ë‚´ì—ì„œ ì¡°ê±´ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ ê²½ë¡œì— ë”°ë¼ ì‹¤í–‰ì„ ì œì–´í•  ìˆ˜ ìˆë‹¤.

## âœ”ï¸ matcher
matcherëŠ” íŠ¹ì • ê²½ë¡œì—ì„œë§Œ middlewareê°€ ì‘ë™í•˜ë„ë¡ í•„í„°ë§í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì„¤ì •ì´ë‹¤.

### 1ï¸âƒ£ ë‹¨ì¼ ê²½ë¡œ ì§€ì •í•˜ê¸°

```typescript
export const config = {
  matcher: '/about/:path*',
}
```
### 2ï¸âƒ£ ì—¬ëŸ¬ ê²½ë¡œ ì§€ì •í•˜ê¸°
```typescript
export const config = {
  matcher: ['/about/:path*', '/dashboard/:path*'],
}
```
### 3ï¸âƒ£ ì •ê·œì‹ ì‚¬ìš©í•˜ê¸°
matcherì˜ ê²½ìš° ì •ê·œì‹ì„ ì§€ì›í•˜ë¯€ë¡œ, ê³ ê¸‰ ì¡°ê±´ì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.

ì‚¬ì‹¤ `matcher`ë¥¼ ì‚¬ìš©í•˜ëŠ” ì˜ˆì œë¥¼ ë³´ë©´ ì–´ë–¤ ê²½ìš°ëŠ” ì‘ì„±ëœ íŠ¹ì • ê²½ë¡œì—ë§Œ middlewareë¥¼ **ì ìš©**í•˜ê³ ,
ë˜ ì–´ë–¤ ê²½ìš°ëŠ” ì‘ì„±ëœ íŠ¹ì • ê²½ë¡œë¥¼ **ì œì™¸**í•˜ê³  ë‚˜ë¨¸ì§€ì— ì ìš©í•˜ëŠ” ë°©ì‹ì´ë¼ í—·ê°ˆë¦¬ê³¤ í–ˆëŠ”ë°.. ğŸ« 

ì •ë¦¬í•˜ìë©´ ì´ë ‡ë‹¤.

- matcherì— ëª…ì‹œí•œ ê²½ë¡œì—ë§Œ ì ìš©ë˜ëŠ” ë°©ì‹ â†’ 1ï¸âƒ£, 2ï¸âƒ£ ì²˜ëŸ¼ ì‚¬ìš©
- íŠ¹ì • ê²½ë¡œë§Œ ì œì™¸í•˜ê³  ì‹¶ì„ ë•Œ â†’ 3ï¸âƒ£ (ì •ê·œì‹) ì²˜ëŸ¼ ì‚¬ìš©


```typescript
export const config = {
  matcher: [
    /*
     * ë‹¤ìŒìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ìš”ì²­ ê²½ë¡œëŠ” ì œì™¸:
     * - api (API ë¼ìš°íŠ¸)
     * - _next/static (ì •ì  íŒŒì¼)
     * - _next/image (ì´ë¯¸ì§€ ìµœì í™” íŒŒì¼)
     * - favicon.ico, sitemap.xml, robots.txt (ë©”íƒ€ë°ì´í„°)
     */
    '/((?!api|_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt).*)',
  ],
}
```
### 4ï¸âƒ£ ì¡°ê±´ë¶€ë¡œ ì ìš©í•˜ê¸°
ë§Œì•½ ìš”ì²­ í—¤ë”ë‚˜ ì¿ í‚¤ ê°’ì— ë”°ë¼ middlewareë¥¼ ì¡°ê±´ë¶€ë¡œ ì‹¤í–‰í•´ì•¼ í•œë‹¤ë©´ `has`ì™€ `missing`ì„ ì´ìš©í•˜ë©´ ëœë‹¤. ì´ ë‘ê°€ì§€ëŠ” í•„ìš”ì— ë”°ë¼ ê°ê° í˜¹ì€ í•¨ê»˜ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.

```typescript
export const config = {
  /*
     * ë‹¤ìŒìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ë¡œëŠ” ì œì™¸ì™¸:
     * - api(API ê²½ë¡œ)
     * - _next/static (ì •ì  íŒŒì¼)
     * - _next/image(ì´ë¯¸ì§€ ìµœì í™” íŒŒì¼)
     * - favicon.ico, sitemap.xml, robots.txt (ë©”íƒ€ë°ì´í„° íŒŒì¼)
     */
  matcher: [
    {
      source:
        '/((?!api|_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt).*)',
      missing: [
        { type: 'header', key: 'next-router-prefetch' },
        { type: 'header', key: 'purpose', value: 'prefetch' },
      ],
    },

    {
      source:
        '/((?!api|_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt).*)',
      has: [
        { type: 'header', key: 'next-router-prefetch' },
        { type: 'header', key: 'purpose', value: 'prefetch' },
      ],
    },

    {
      source:
        '/((?!api|_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt).*)',
      has: [{ type: 'header', key: 'x-present' }],
      missing: [{ type: 'header', key: 'x-missing', value: 'prefetch' }],
    },
  ],
}
```

### ğŸ¤— matcher ì‚¬ìš© ë°©ì‹ ì •ë¦¬
1. ë°˜ë“œì‹œ `/`ë¡œ ì‹œì‘í•´ì•¼ í•œë‹¤. 
2. `parameter`ë¥¼ í¬í•¨í•  ìˆ˜ ìˆë‹¤. 
  - `/about/:path`ëŠ” `/about/a` ë° `/about/b`ì™€ ë§¤ì¹­ë˜ì§€ë§Œ `/about/a/c`ëŠ” ë§¤ì¹­ë˜ì§€ì§€ ì•ŠëŠ”ë‹¤.
3. ì´ë¦„ì´ ì§€ì •ëœ `parameter`ì—ëŠ” **ìˆ˜ì‹ì(modifier)**ë¥¼ ë¶™ì¼ ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `/about/:path*`ëŠ” `/about/a/b/c`ì™€ ë§¤ì¹­ëœë‹¤. 
  - `*` â†’ 0ê°œ ì´ìƒ
  - `?` â†’ 0ê°œ ë˜ëŠ” 1ê°œ
  - `+` â†’ 1ê°œ ì´ìƒ

4. ê´„í˜¸ë¡œ ë¬¶ì¸ ì •ê·œì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ `/about/(.*)`ì™€ `/about/:path*`ëŠ” ê°™ë‹¤.