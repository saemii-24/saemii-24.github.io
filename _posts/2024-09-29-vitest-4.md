---
title: "FEí…ŒìŠ¤íŠ¸(4) - ì „ì—­ ìƒíƒœ ê´€ë¦¬"
author: saemii
categories:
  - Test
tags:
  - [Vitest, ReatTestingLibrary]
date: 2024-09-29
last_modified_at: 2024-09-29
pin: true
---

## ğŸ“Œì‹œì‘í•˜ë©°

ê¸°ë³¸ì ì¸ í…ŒìŠ¤íŠ¸ ê³¼ì •ê³¼ íë¦„ì— ëŒ€í•´ ì•Œì•„ë´¤ìœ¼ë‹ˆ ì´ë²ˆì—” context APIë‚˜ zustandì™€ ê°™ì€ ì „ì—­ ìƒíƒœ ê´€ë¦¬ë¥¼ í…ŒìŠ¤íŠ¸ í•´ë³´ì.

## âœ…context API

ì‚¬ì‹¤ ì²˜ìŒì—” **ì „ì—­ ìƒíƒœ ê´€ë¦¬** ë¥¼ í…ŒìŠ¤íŠ¸ í•œë‹¤ëŠ” ê±°ì— ì–´ë–»ê²Œ í•˜ëŠ”ê±´ì§€ ê³ ë¯¼ë˜ì—ˆì§€ë§Œ,
**ì „ì—­ ìƒíƒœ ê´€ë¦¬** ì— ì´ˆì ì„ ë§ì¶”ì§€ ë§ê³  **ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì§€ëŠ” ê²ƒ** ì— ì´ˆì ì„ ë§ì¶°ë³´ë©´ ì‰½ê²Œ í…ŒìŠ¤íŠ¸ í•  ìˆ˜ ìˆë‹¤.

ì „ì²´ì ì¸ íë¦„ë„ ì•ì„œ ì‚´í´ë³¸ ê²ƒê³¼ ë™ì¼í•˜ë‹¤.
íŠ¹ë³„íˆ ì „ì—­ ìƒíƒœ ê´€ë¦¬ë¥¼ ìœ„í•´ APIë¥¼ ì“°ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ Aì—ì„œ íŠ¸ë¦¬ê±°ë¥¼ ë°œìƒì‹œí‚¤ê³  Bì— ì œëŒ€ë¡œ ë°˜ì˜ì´ ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•˜ë©´ ë˜ê¸° ë•Œë¬¸ì´ë‹¤.

### â¡ï¸ì˜ˆì œ

ë¨¼ì € context APIë¥¼ ì‘ì„±í•´ì£¼ì—ˆë‹¤.

```typescript
import React, { createContext, useContext, useState, ReactNode } from "react"

// CountContext íƒ€ì… ì •ì˜
interface CountContextType {
  count: number
  increment: () => void
}

// Context ìƒì„±
const CountContext = createContext<CountContextType | undefined>(undefined)

// Provider ì»´í¬ë„ŒíŠ¸
export const CountProvider: React.FC<{ children: ReactNode }> = ({
  children,
}) => {
  const [count, setCount] = useState(0)

  const increment = () => setCount((prev) => prev + 1)

  return (
    <CountContext.Provider value={{ count, increment }}>
      {children}
    </CountContext.Provider>
  )
}

// Hookì„ ì‚¬ìš©í•˜ì—¬ Context ê°’ ì ‘ê·¼
export const useCount = () => {
  const context = useContext(CountContext)
  if (!context) {
    throw new Error("ì—ëŸ¬ ë°œìƒ!")
  }
  return context
}
```

ì´í›„ ê³¼ì •ì€ A ì»´í¬ë„ŒíŠ¸ì—ì„œ incrementë¥¼ í˜¸ì¶œí•˜ê³  B ì»´í¬ë„ŒíŠ¸ì—ì„œ ìˆ«ìë¥¼ ë Œë”ë§í•œë‹¤.
ê°„ë‹¨í•œ ë¶€ë¶„ì´ë¼ ì½”ë“œëŠ” ìƒëµí•œë‹¤.

```typescript
import { CountProvider } from "@/context/CountContext"
import React from "react"
import { AComponent } from "./AComponent"
import { BComponent } from "./BComponent"

const AllComponent = () => {
  return (
    <CountProvider>
      <AComponent />
      <BComponent />
    </CountProvider>
  )
}

export default AllComponent
```

ì´í›„ ë‹¤ìŒê³¼ ê°™ì´ `AComponent`ì™€ `BComponent`ë¥¼ `CountProvider`ë¡œ ê°ì‹¸ì£¼ì—ˆë‹¤.
ê·¸ë¦¬ê³  í…ŒìŠ¤íŠ¸ `AllComponent.spec.tsx`ë¥¼ ì‘ì„±í•´ ì£¼ì—ˆë‹¤.

ì „ì²´ íë¦„ì€ ìœ„ì—ì„œ ì„¤ëª…í•œ ê²ƒ ì²˜ëŸ¼, ì‚¬ìš©ì ì¸¡ë©´ì—ì„œ í…ŒìŠ¤íŠ¸ ì‘ì„±í•´ì£¼ë©´ ëœë‹¤.

```typescript
import { render, screen, fireEvent } from "@testing-library/react"
import { describe, it, expect } from "vitest"
import AllComponent from "./AllComponent"

describe("All Componet Context API", () => {
  it("A ì»´í¬ë„ŒíŠ¸ì—ì„œ countë¥¼ ì¦ê°€ì‹œí‚¤ë©´, B ì»´í¬ë„ŒíŠ¸ì—ì„œë„ countê°€ ì—…ë°ì´íŠ¸ ëœë‹¤.", () => {
    render(<AllComponent />)

    //aCountì™€ bCountê°€ ë™ì¼í•˜ê¸° ë•Œë¬¸ì— <p data-testid="a-count"/> ì†ì„±ì„ ì‚¬ìš©í•´ êµ¬ë¶„í•œë‹¤.
    //êµ¬ë¶„í•  ìˆ˜ ì—†ì„ë•Œë§Œ ì‚¬ìš©í•¨ì— ì£¼ì˜
    const aCount = screen.getByTestId("a-count")
    const bCount = screen.getByTestId("b-count")

    //ì¦ê°€ ë²„íŠ¼ì„ í´ë¦­í•œë‹¤.
    fireEvent.click(screen.getByText(/ì¦ê°€/i))

    // A ì»´í¬ë„ŒíŠ¸ì˜ countê°€ 1ë¡œ ì—…ë°ì´íŠ¸ ë˜ì—ˆëŠ”ì§€ í™•ì¸
    expect(aCount).toHaveTextContent("Count: 1")

    // B ì»´í¬ë„ŒíŠ¸ì˜ countë„ 1ë¡œ ì—…ë°ì´íŠ¸ ë˜ì—ˆëŠ”ì§€ í™•ì¸
    expect(bCount).toHaveTextContent("Count: 1")
  })
})
```

## âœ…zustand

ê·¸ëŸ¼ ì´ë²ˆì—ëŠ” ë¦¬ì•¡íŠ¸ ê¸°ë³¸ ë‚´ì¥ ì „ì—­ ìƒíƒœ ê´€ë¦¬ê°€ ì•„ë‹ˆë¼, ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í–ˆì„ ë•Œì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•´ë³´ì.
[zustand ê³µì‹ë¬¸ì„œ](https://zustand.docs.pmnd.rs/guides/testing)ì—ì„œëŠ” í…ŒìŠ¤íŠ¸ì— ëŒ€í•´ ìì„¸íˆ ì„¤ëª…í•˜ê³  ìˆë‹¤.

ê³µì‹ë¬¸ì„œì—ì„œ ì œì•ˆí•˜ëŠ” ë°©ì‹ì— ë”°ë¼ ì§„í–‰í•´ë³´ì.

ë¨¼ì € Zustandì²˜ëŸ¼ ì „ì—­ ìƒíƒœ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í…ŒìŠ¤íŠ¸í•  ë•ŒëŠ” Aí…ŒìŠ¤íŠ¸ì—ì„œ ë³€ê²½ëœ ê°’ì´ Bí…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šë„ë¡, ê°’ì„ ì´ˆê¸°í™”í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.

### â¡ï¸`__mocks__` í´ë” ë§Œë“¤ê¸°

`__mocks__` í´ë”ë¥¼ ë£¨íŠ¸ ê²½ë¡œì— ë§Œë“ ë‹¤. ë§Œì•½ src ë””ë ‰í† ë¦¬ë¥¼ ì„¤ì •í•œ ê²½ìš°ì—ëŠ” `src/__mocks__/zustand.ts`ì— ëª¨í‚¹ íŒŒì¼ì„ ë„£ëŠ”ë‹¤.
ë‚˜ëŠ” src í´ë”ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë¯€ë¡œ, src í´ë” ì•ˆì— `__mocks__` í´ë”ë¥¼ ë§Œë“¤ê³  `zustand.ts`íŒŒì¼ì„ ë§Œë“¤ì–´ ì£¼ì—ˆë‹¤.

í•„ìš”í•œ ì½”ë“œë¥¼ ê³µì‹ë¬¸ì„œì—ì„œ ì´ë¯¸ ì œì‹œí•˜ê³  ìˆì–´, ê°„ë‹¨í•˜ê²Œ í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

```typescript
// __mocks__/zustand.ts
import * as zustand from "zustand"
import { act } from "@testing-library/react"

const { create: actualCreate, createStore: actualCreateStore } =
  await vi.importActual<typeof zustand>("zustand")

// a variable to hold reset functions for all stores declared in the app
export const storeResetFns = new Set<() => void>()

const createUncurried = <T>(stateCreator: zustand.StateCreator<T>) => {
  const store = actualCreate(stateCreator)
  const initialState = store.getInitialState()
  storeResetFns.add(() => {
    store.setState(initialState, true)
  })
  return store
}

// when creating a store, we get its initial state, create a reset function and add it in the set
export const create = (<T>(stateCreator: zustand.StateCreator<T>) => {
  console.log("zustand create mock")

  // to support curried version of create
  return typeof stateCreator === "function"
    ? createUncurried(stateCreator)
    : createUncurried
}) as typeof zustand.create

const createStoreUncurried = <T>(stateCreator: zustand.StateCreator<T>) => {
  const store = actualCreateStore(stateCreator)
  const initialState = store.getInitialState()
  storeResetFns.add(() => {
    store.setState(initialState, true)
  })
  return store
}

// when creating a store, we get its initial state, create a reset function and add it in the set
export const createStore = (<T>(stateCreator: zustand.StateCreator<T>) => {
  console.log("zustand createStore mock")

  // to support curried version of createStore
  return typeof stateCreator === "function"
    ? createStoreUncurried(stateCreator)
    : createStoreUncurried
}) as typeof zustand.createStore

// reset all stores after each test run
afterEach(() => {
  act(() => {
    storeResetFns.forEach((resetFn) => {
      resetFn()
    })
  })
})
```

ì‹¤ì œ í…ŒìŠ¤íŠ¸ëŠ” ì•„ë˜ì™€ ê°™ì€ ê³¼ì •ì—ì„œ ì§„í–‰í•œë‹¤.

```typescript
import { render, screen, act } from "@testing-library/react"
import userEvent from "@testing-library/user-event"
import { describe, it, expect, beforeEach, vi } from "vitest"
import ZustandComponent from "./ZustandComponent"
import { mockReset, mockDecrement, mockIncrement } from "../stores/MockZustand"

describe("ZustandComponent í…ŒìŠ¤íŠ¸", () => {
  ;("")
  beforeEach(() => {
    vi.clearAllMocks()
    // ìƒíƒœ ì´ˆê¸°í™”
    mockReset()
  })

  it("ì´ˆê¸° ë Œë”ë§ ì‹œ countëŠ” 0ì´ì–´ì•¼ í•œë‹¤", () => {
    render(<ZustandComponent />)
    expect(screen.getByText(/^Count: 0$/)).toBeInTheDocument()
  })

  it("+ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ countê°€ 1ì”© ì¦ê°€í•´ì•¼ í•œë‹¤", async () => {
    render(<ZustandComponent />)
    const user = userEvent.setup()

    mockIncrement() // Increment í•¨ìˆ˜ ëª¨í‚¹

    // await act(async () => {
    //   await user.click(screen.getByTestId("plus"));
    // });

    // count ê°’ì´ ì¦ê°€í–ˆëŠ”ì§€ í™•ì¸
    expect(screen.getByTestId("count")).toBeInTheDocument()
  })

  it("(Zustand) - ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ countê°€ 1ì”© ê°ì†Œí•´ì•¼ í•œë‹¤", async () => {
    render(<ZustandComponent />)
    const user = userEvent.setup()

    mockDecrement() // Decrement í•¨ìˆ˜ ëª¨í‚¹

    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì£¼ì„ì„ í•´ì œí•´ì•¼ í•¨
    // await act(async () => {
    //   await user.click(screen.getByTestId("minus"));
    // });

    // count ê°’ì´ ê°ì†Œí–ˆëŠ”ì§€ í™•ì¸
    expect(screen.getByTestId("count")).toBeInTheDocument()
  })

  it("(UI) - ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ countê°€ 1ì”© ê°ì†Œí•´ì•¼ í•œë‹¤", async () => {
    render(<ZustandComponent />)
    //ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¤€ë¹„
    const user = userEvent.setup()

    // ìƒíƒœ ëª¨í‚¹ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬
    await act(async () => {
      await user.click(screen.getByTestId("minus"))
    })

    // count ê°’ì´ ê°ì†Œí–ˆëŠ”ì§€ í™•ì¸
    expect(screen.getByTestId("count")).toBeInTheDocument()
  })
})
```
