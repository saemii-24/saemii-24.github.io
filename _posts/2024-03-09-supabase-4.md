---
title: "supabaseì™€ prisma(4) - storage ì´ìš©í•˜ê¸°"
author: saemii
categories:
  - Supabase
tags:
  - [Supabase, Next.js]
date: 2024-03-09
last_modified_at: 2024-03-09
pin: true
---

## ğŸ“Œì‹œì‘í•˜ë©°

í”„ë¡œì íŠ¸ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³ , í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•  í•„ìš”ê°€ ìˆì—ˆë‹¤! supabaseì˜ storageë¥¼ ì´ìš©í•˜ë©´ ë˜ëŠ”ë°, ì–´ë–»ê²Œ ì½”ë“œë¥¼ ì‘ì„±í–ˆëŠ”ì§€ ëŒì•„ë³´ë©° ì •ë¦¬í•´ë³´ê³ ì í•œë‹¤.

> ì´ ê¸€ì€ ì•„ë˜ì™€ ê°™ì´ ì´ì–´ì§‘ë‹ˆë‹¤.
>
> - [supabaseì™€ prisma(1) - ê¸°ë³¸ ê°œë…](https://saemii-24.github.io/posts/supabase-1/)
> - [supabaseì™€ prisma(2) - prisma CRUD](https://saemii-24.github.io/posts/supabase-2/)
> - [supabaseì™€ prisma(3) - prisma ì‹¬í™”](https://saemii-24.github.io/posts/supabase-3/)
> - [supabaseì™€ prisma(4) -storage ì´ìš©í•˜ê¸°](https://saemii-24.github.io/posts/supabase-4/)

## âœ…storage

Supabaseì˜ Storageë¥¼ ì‚¬ìš©í•˜ë©´ ë‹¤ì–‘í•œ í¬ê¸°ì˜ ì´ë¯¸ì§€, ë™ì˜ìƒ, PDFë“±ì˜ íŒŒì¼ì„ ê°„í¸í•˜ê²Œ ì—…ë¡œë“œ í•  ìˆ˜ ìˆë‹¤.

ë¨¼ì €, Supabaseì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ” ê³¼ì •ì—ì„œëŠ” Prismaë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ” ë§Œí¼, Prismaë¥¼ ì´ìš©í•´ ì—…ë¡œë“œ í•  ë°©ë²•ì„ ì°¾ì•„ë³´ì•˜ëŠ”ë° storage ì—…ë¡œë“œì—ëŠ” Supabaseë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ë“¯ í–ˆë‹¤.

ë‹¤í–‰íˆë„ ì½”ë“œë„ ì–´ë µì§€ ì•Šê¸° ë•Œë¬¸ì— ê¸ˆë°© ì‘ì„±í•  ìˆ˜ ìˆë‹¤!

**ì „ì²´ì ì¸ ì—…ë¡œë“œ ê³¼ì •**ì€ ì•„ë˜ì™€ ê°™ë‹¤.

```mermaid
graph LR;
A[ì‚¬ìš©ì] --> B(íŒŒì¼ ì—…ë¡œë“œ);
B --> C(í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ<BR/> ìŠ¤í† ë¦¬ì§€ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ);
C --> D(ì—…ë¡œë“œëœ<BR/> ì´ë¯¸ì§€ URL ì–»ê¸°);
D --> F(í•´ë‹¹ URL ì •ë³´ë¥¼ Bodyì— ë‹´ê³ ,<BR/>Next APIì— POST ìš”ì²­)
F --> G(Prismaë¥¼ ì´ìš©í•´<br/> Supabaseì— ì—…ë¡œë“œ);
```

## âœ…Typescriptìš© type ë§Œë“¤ê¸°

ì•„ë˜ ì½”ë“œë¥¼ í„°ë¯¸ë„ì— ì…ë ¥í•´ ë‚´ê°€ ë§Œë“  í…Œì´ë¸”ì˜ typeì„ ë§Œë“¤ì–´ ì¤„ ìˆ˜ ìˆë‹¤. ì´ë ‡ê²Œ íƒ€ì…ì„ ë§Œë“¤ê³  clientì— ì ìš©í•´ì£¼ë©´, ì‘ì„± ì¤‘ì— ì˜ë„ì¹˜ ì•Šì€ ì˜¤íƒ€ì—ì„œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ë¥¼ ë§‰ì•„ì¤„ ìˆ˜ ìˆìœ¼ë‹ˆ ê¼­ íƒ€ì…ì„ ì§€ì •í•´ì£¼ì!

```bash
npx supabase gen types typescript --project-id abcdefghijklmnopqrst > database.types.ts
```

ì •ìƒ ì‘ë™ ë˜ë©´ `database.types.ts`ì— ë‚´ê°€ ë§Œë“  í…Œì´ë¸”ì— ì í•©í•œ íƒ€ì…ì´ ìë™ìœ¼ë¡œ ìƒì„±ëœë‹¤.

## âœ…client ë§Œë“¤ê¸°

supabase clientëŠ” í´ë¼ì´ì–¸íŠ¸, ì„œë²„, ë¯¸ë“¤ì›¨ì–´ ì´ë ‡ê²Œ ì„¸ ê°€ì§€ ìƒíƒœì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” clientê°€ ìˆë‹¤. ë‚˜ëŠ” client ì¸¡ì—ì„œ ìŠ¤í† ë¦¬ì§€ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•  ì˜ˆì •ì´ë¯€ë¡œ, í´ë¼ì´ì–¸íŠ¸ ì¸¡ supabase clientë¥¼ ë§Œë“¤ì–´ ì£¼ì—ˆê³ , ìœ„ì—ì„œ ì •ì˜í•œ `Database`íƒ€ì…ì„ ì ìš©í•´ì£¼ì—ˆë‹¤.

ì´ë•Œ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ ë³€ìˆ˜ëŠ” `.env.local`íŒŒì¼ì— ì •ì˜í•´ì£¼ë©´ ëœë‹¤.

```typescript
import { createBrowserClient } from "@supabase/ssr"
import { Database } from "../../database.types"

export const createClient = () =>
  createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
```

## âœ…ì—…ë¡œë“œ ì½”ë“œ

ì „ì²´ì ì¸ ì½”ë“œ íë¦„ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```mermaid
graph LR;
A[ì—…ë¡œë“œ ëœ íŒŒì¼] --> B(íŒŒì¼ í™•ì¥ì í™•ì¸);
B --> |í†µê³¼|C(ì—…ë¡œë“œ);
C --> |ì‹¤íŒ¨|D(ì‹¤íŒ¨ ë˜ì—ˆìŒì„ ì•Œë¦¼);
C --> |ì„±ê³µ|F(URL ê°’ ì–»ì–´ì˜¤ê¸°);
F --> G(URL ê°’ì„ Bodyì— ë„£ì–´<br/> apiì— POST ìš”ì²­);
```

ì‹¤íŒ¨í•œ ê²½ìš°, ë¡œë”© ì¤‘ì¸ ê²½ìš°ëŠ” toastë¥¼ ë„ì›Œì£¼ê³ ì `react-toastify`ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í–ˆê³ , íŒŒì¼ëª… ë•Œë¬¸ì— ì—…ë¡œë“œê°€ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ê°€ ë°œìƒí•´ ì—…ë¡œë“œ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ file ëª…ì„ ë”°ë¡œ ë§Œë“¤ì–´ ì‚¬ìš©í•´ì£¼ì—ˆë‹¤.

```typescript
import { FormValues } from "@/types/form"
import { createClient } from "@/supabase/client"

import axios from "axios"
import { toast } from "react-toastify"

//react-hook-form í¼ ì´ìš©
export const onSubmit = async (data: FormValues) => {
  const supabase = createClient()

  //file ì´ ì—…ë¡œë“œ ë˜ì—ˆì„ ë•Œ ì²˜ë¦¬
  let fileName = new Date().getTime()
  let file = data.thumbnail![0]

  let fileUrl = null

  if (file) {
    //ì´ë¯¸ì§€ ì—…ë¡œë“œë“œ
    const { data: uploadData, error } = await supabase.storage
      .from("thumbnail")
      .upload(`image_${fileName}`, file) ğŸ‘ˆ

    //ë§Œì•½ ì—…ë¡œë“œê°€ ì‹¤íŒ¨í•œ ê²½ìš°
    if (error) {
      console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", error.message)
      toast.error("ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
    } else {
      //URL ì–»ê¸°
      const { data: uploadUrl } = await supabase.storage
        .from("thumbnail")
        .getPublicUrl(uploadData!.path) ğŸ‘ˆ

      fileUrl = uploadUrl.publicUrl
    }
  }

  //íŒŒì¼ urlë¡œ ë³€ê²½ ì™„ë£Œ, apiì— post ìš”ì²­
  try {
    const response = await axios.post("/api/music", {
       //data = react hook formì—ì„œ ì–»ì€ ë‚´ìš©ë“¤
      title: data.title,
      singer: data.singer,
      language: data.language,
      thumbnail: fileUrl, //URL ë‚´ìš©ì„ ë‹´ì•„ ë³´ëƒ„
    })
    return response.data
  } catch (err) {
    console.error("ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ", err)
    toast.error("ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
  }
}

//file í™•ì¸
export const checkFileType = (value?: FileList) => {
  if (value && value[0]) {
    // í™•ì¥ì í™•ì¸
    const correctFormat = ["image/png", "image/jpg", "image/webp", "image/jpeg"]
    const file = value[0]
    const fileExtension = file.type.toLowerCase()

    if (value[0].size > 1048576) {
      return "* 1MB ì´í•˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”."
    }
    if (!correctFormat.includes(fileExtension)) {
      return "* PNG ë˜ëŠ” JPG íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”."
    }
  }
  return true
}
```

## âœ…API ì‘ì„±

ì—…ë¡œë“œ apiëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•´ì£¼ì—ˆë‹¤. `req.json()`ì„ í†µí•´ bodyê°’ì„ êµ¬ì¡°ë¶„í•´ í• ë‹¹í•˜ê³ , `language`ê°’ì— ë”°ë¼ ì—…ë¡œë“œ í•„ë“œê°€ ë‹¬ë¼ì§€ê¸°ì—, ì¡°ê±´ë¬¸ìœ¼ë¡œ ì²˜ë¦¬í–ˆë‹¤.

```typescript
export const POST = async (req: Request, res: NextResponse) => {
  try {
    //body ê°’ ë°›ì•„ì˜¤ê¸°
    const { title, singer, thumbnail, language } = await req.json()

    let post
    if (language === "í•œêµ­ì–´") {
      post = await prisma.post.create({
        data: {
          kotitle: title,
          kosinger: singer,
          kothumbnail: thumbnail,
        },
      })
    } else {
      post = await prisma.post.create({
        data: {
          jptitle: title,
          jpsinger: singer,
          jpthumbnail: thumbnail,
        },
      })
    }
    return NextResponse.json({ message: "Success", post }, { status: 201 })
  } catch (err) {
    return NextResponse.json({ message: "Error", err }, { status: 500 })
  }
}
```

## ğŸ“©ë§ˆë¬´ë¦¬

ì´ë ‡ê²Œ supabaseë¥¼ ì¨ì„œ ì—…ë¡œë“œ í•˜ëŠ” ê²ƒ ê¹Œì§€ëŠ” ì „ë¶€ ë§ˆë¬´ë¦¬ê°€ ë˜ì—ˆë‹¤!
ì´í›„ ì´ url ì‚¬ìš© ì¤‘ì— ë°œìƒí•œ ì˜¤ë¥˜ëŠ” [ì´ë ‡ê²Œ](https://saemii-24.github.io/posts/error-1/) í•´ê²°í–ˆë‹¤.ğŸ˜

## ğŸ—‚ï¸ì°¸ê³  ì‚¬ì´íŠ¸

- <https://supabase.com/docs/guides/storage>
- <https://supabase.com/docs/reference/javascript/typescript-support>
